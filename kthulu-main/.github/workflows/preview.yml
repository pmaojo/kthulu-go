name: Preview

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Render manifests
        run: kustomize build kustomize/overlays/dev > manifests.yaml

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign manifests
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign sign-blob --yes --key "${{ secrets.COSIGN_KEY }}" manifests.yaml > manifests.sig

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output: sbom.spdx.json

      - name: Attest SBOM
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cosign attest --yes --key "${{ secrets.COSIGN_KEY }}" --predicate sbom.spdx.json --type spdxjson manifests.yaml

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: preview
          path: |
            manifests.yaml
            manifests.sig
            sbom.spdx.json

      - name: Argo CD PR Generator
        uses: akuity/argocd-pr-generator-action@v0.6.0
        with:
          app-spec: |
            project: default
            source:
              repoURL: ${{ github.repositoryUrl }}
              targetRevision: ${{ github.head_ref }}
              path: kustomize/overlays/dev
            destination:
              server: https://kubernetes.default.svc
              namespace: kthulu-pr-${{ github.event.number }}
