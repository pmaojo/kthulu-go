package {{.Package}}

import (
        "bytes"
        "context"
        "net/http"
        "net/http/httptest"
        "testing"

        "github.com/go-chi/chi/v5"
)

type mock{{.HandlerName}}Service struct {
        response *{{.HandlerName}}Response
        err      error
        called   bool
        received *{{.HandlerName}}Request
}

var _ {{.ServiceInterface}} = (*mock{{.HandlerName}}Service)(nil)

func (m *mock{{.HandlerName}}Service) {{.ServiceMethod}}(_ context.Context, req *{{.HandlerName}}Request) (*{{.HandlerName}}Response, error) {
        m.called = true
        m.received = req
        return m.response, m.err
}

func Test{{.HandlerName}}HandlerDelegatesToPort(t *testing.T) {
        mockSvc := &mock{{.HandlerName}}Service{
                response: &{{.HandlerName}}Response{Result: "ok"},
        }
        handler := New{{.HandlerName}}(mockSvc)
        router := chi.NewRouter()
        handler.RegisterRoutes(router)

        req := httptest.NewRequest(http.MethodPost, "{{.Route}}", bytes.NewBufferString(`{"payload":"demo"}`))
        resp := httptest.NewRecorder()

        router.ServeHTTP(resp, req)

        if resp.Code != http.StatusOK {
                t.Fatalf("expected status %d, got %d", http.StatusOK, resp.Code)
        }
        if !mockSvc.called {
                t.Fatalf("expected service to be called")
        }
        if mockSvc.received == nil || mockSvc.received.Payload != "demo" {
                t.Fatalf("expected DTO payload to be propagated, got %+v", mockSvc.received)
        }
}

func Test{{.HandlerName}}HandlerRejectsInvalidJSON(t *testing.T) {
        mockSvc := &mock{{.HandlerName}}Service{}
        handler := New{{.HandlerName}}(mockSvc)
        router := chi.NewRouter()
        handler.RegisterRoutes(router)

        req := httptest.NewRequest(http.MethodPost, "{{.Route}}", bytes.NewBufferString(`not-json`))
        resp := httptest.NewRecorder()

        router.ServeHTTP(resp, req)

        if resp.Code != http.StatusBadRequest {
                t.Fatalf("expected status %d, got %d", http.StatusBadRequest, resp.Code)
        }
        if mockSvc.called {
                t.Fatalf("service must not be invoked when decoding fails")
        }
}
