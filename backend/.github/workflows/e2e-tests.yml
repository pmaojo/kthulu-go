name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run E2E tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  GO_VERSION: '1.23'

jobs:
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: kthulu_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          e2e/package-lock.json

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Install E2E dependencies
      run: |
        cd e2e
        npm ci

    - name: Install Playwright browsers
      run: |
        cd e2e
        npx playwright install --with-deps

    - name: Build frontend
      run: |
        cd frontend
        npm run build

    - name: Build backend
      run: |
        cd backend
        go build -o kthulu-app cmd/service/main.go

    - name: Run backend integration tests
      run: |
        cd backend
        go test -v -tags=integration ./internal/integration/... \
          -coverprofile=../test-results/backend-integration-coverage.out
      env:
        DB_DRIVER: postgres
        DB_URL: postgres://postgres:postgres@localhost:5432/kthulu_test?sslmode=disable
        JWT_SECRET: test-jwt-secret-for-ci
        JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci

    - name: Start backend server
      run: |
        cd backend
        ./kthulu-app &
        echo $! > ../backend.pid
      env:
        DB_DRIVER: sqlite
        DB_URL: ":memory:"
        JWT_SECRET: test-jwt-secret-for-ci
        JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-ci
        SERVER_PORT: 8080
        LOG_LEVEL: warn

    - name: Wait for backend server
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

    - name: Run Playwright E2E tests
      run: |
        cd e2e
        npx playwright test
      env:
        CI: true
        BASE_URL: http://localhost:8080

    - name: Upload Playwright report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: e2e/playwright-report/
        retention-days: 30

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          e2e/test-results/
          test-results/
        retention-days: 30

    - name: Upload backend coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-coverage
        path: test-results/backend-integration-coverage.out
        retention-days: 30

    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
        fi

    - name: Comment PR with test results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          let comment = '## ðŸ§ª E2E Test Results\n\n';
          
          // Check if Playwright results exist
          const playwrightResultsPath = 'e2e/test-results/results.json';
          if (fs.existsSync(playwrightResultsPath)) {
            const results = JSON.parse(fs.readFileSync(playwrightResultsPath, 'utf8'));
            const { stats } = results;
            
            comment += `### Frontend E2E Tests\n`;
            comment += `- âœ… Passed: ${stats.passed}\n`;
            comment += `- âŒ Failed: ${stats.failed}\n`;
            comment += `- â­ï¸ Skipped: ${stats.skipped}\n`;
            comment += `- â±ï¸ Duration: ${Math.round(stats.duration / 1000)}s\n\n`;
          }
          
          // Check if backend integration results exist
          const backendResultsPath = 'test-results/backend-integration-results.json';
          if (fs.existsSync(backendResultsPath)) {
            comment += `### Backend Integration Tests\n`;
            comment += `- Results available in artifacts\n\n`;
          }
          
          comment += `### ðŸ“Š Reports\n`;
          comment += `- [Playwright Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          comment += `- [Test Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
          
          // Post comment
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Install dependencies
      run: |
        cd backend
        go mod download

    - name: Run contract tests
      run: |
        cd backend
        go test -v ./internal/contracts/... \
          -coverprofile=../test-results/contract-coverage.out

    - name: Generate coverage report
      run: |
        cd backend
        go tool cover -html=../test-results/contract-coverage.out \
          -o ../test-results/contract-coverage.html

    - name: Upload contract test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: contract-test-results
        path: test-results/
        retention-days: 30

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend/go.sum

    - name: Build backend
      run: |
        cd backend
        go build -o kthulu-app cmd/service/main.go

    - name: Start backend server
      run: |
        cd backend
        ./kthulu-app &
        echo $! > ../backend.pid
      env:
        DB_DRIVER: sqlite
        DB_URL: ":memory:"
        JWT_SECRET: test-jwt-secret-for-perf
        JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-perf
        SERVER_PORT: 8080
        LOG_LEVEL: error

    - name: Wait for backend server
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8080/health; do sleep 2; done'

    - name: Install Apache Bench
      run: sudo apt-get update && sudo apt-get install -y apache2-utils

    - name: Run performance tests
      run: |
        # Health endpoint performance
        ab -n 1000 -c 10 http://localhost:8080/health > perf-health.txt
        
        # Create performance report
        echo "# Performance Test Results" > performance-report.md
        echo "" >> performance-report.md
        echo "## Health Endpoint" >> performance-report.md
        echo '```' >> performance-report.md
        cat perf-health.txt >> performance-report.md
        echo '```' >> performance-report.md

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: |
          perf-*.txt
          performance-report.md
        retention-days: 30

    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend.pid ]; then
          kill $(cat backend.pid) || true
        fi

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Gosec Security Scanner
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: '-fmt sarif -out gosec-results.sarif ./backend/...'

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gosec-results.sarif

    - name: Run npm audit
      run: |
        cd frontend
        npm audit --audit-level moderate

    - name: Run E2E security audit
      run: |
        cd e2e
        npm audit --audit-level moderate